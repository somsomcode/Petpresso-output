<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì´ë¯¸ì§€ ì—…ë¡œë“œ</title>
  <style>
    body { font-family: sans-serif; padding: 40px; text-align: center; }
    #result { margin-top: 30px; display: none; }
    input[type="text"] { width: 200px; }
    #image-list { margin-top: 20px; }
    .item {
      margin-bottom: 12px;
    }
    .item button {
      margin-left: 10px;
    }
    #result button {
      margin-left: 6px;
    }
  </style>
</head>
<body>
  <h2>ì‚¬ìš©ì ì „ë‹¬ìš© ì´ë¯¸ì§€ ì—…ë¡œë“œ</h2>

  <form id="upload-form" enctype="multipart/form-data">
    ì‚¬ìš©ì ID: <input type="text" name="userId" required><br><br>
    ì´ë¯¸ì§€ ì„ íƒ: <input type="file" name="image" accept="image/*" required><br><br>
    <button type="submit">ì—…ë¡œë“œ</button>
  </form>

  <div id="result">
    <p>âœ… ì—…ë¡œë“œ ì™„ë£Œ! ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•˜ê±°ë‚˜ ë°”ë¡œ í™•ì¸í•˜ì„¸ìš”:</p>
    <input id="result-link" type="text" readonly style="width: 300px;">
    <button onclick="copyLink()">ë³µì‚¬</button>
    <button onclick="goToLink()">ë°”ë¡œê°€ê¸°</button>
  </div>

  <h3 style="margin-top: 60px;">ğŸ“‚ ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ëª©ë¡</h3>
  <div id="image-list">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <script>
    const form = document.getElementById('upload-form');
    const resultDiv = document.getElementById('result');
    const resultInput = document.getElementById('result-link');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const userId = formData.get('userId');

      const res = await fetch('/upload', {
        method: 'POST',
        body: formData
      });

      if (res.ok) {
        const url = `${window.location.origin}/view.html?id=${userId}`;
        resultInput.value = url;
        resultDiv.style.display = 'block';
        form.reset();
        loadImageList();
      } else {
        alert('âŒ ì—…ë¡œë“œ ì‹¤íŒ¨! ì„œë²„ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    function copyLink() {
      const input = document.getElementById('result-link');
      input.select();
      document.execCommand('copy');
      alert('ğŸ“‹ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    function goToLink() {
      const url = document.getElementById('result-link').value;
      if (url) window.open(url, '_blank');
    }

    async function loadImageList() {
      const listContainer = document.getElementById('image-list');
      listContainer.innerHTML = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

      try {
        const res = await fetch('/list');
        const data = await res.json();

        if (!data || Object.keys(data).length === 0) {
          listContainer.innerHTML = '<p>ì•„ì§ ì—…ë¡œë“œëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        const html = Object.entries(data).map(([id, path]) => `
          <div class="item">
            <a href="/view.html?id=${id}" target="_blank">${id}</a>
            (<a href="${path}" target="_blank">ì›ë³¸ë³´ê¸°</a>)
            <button onclick="deleteImage('${id}')">ì‚­ì œ</button>
          </div>
        `).join('');

        listContainer.innerHTML = html;
      } catch (error) {
        console.error('âŒ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
        listContainer.innerHTML = '<p>âŒ ë¦¬ìŠ¤íŠ¸ ë¡œë”© ì˜¤ë¥˜</p>';
      }
    }

    async function deleteImage(id) {
      if (!confirm(`ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (${id})`)) return;

      try {
        const res = await fetch('/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: id })
        });

        if (res.ok) {
          alert('âœ… ì‚­ì œ ì™„ë£Œ');
          loadImageList();
        } else {
          alert('âŒ ì‚­ì œ ì‹¤íŒ¨');
        }
      } catch (err) {
        alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
        console.error(err);
      }
    }

    loadImageList();
  </script>
</body>
</html>
